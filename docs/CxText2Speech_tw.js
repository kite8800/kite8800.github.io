(function (Scratch) {
    "use strict";
	
	// Ported by kitedriver
	const svgIcon = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4NCjwhLS0gR2VuZXJhdG9yOiBBZG9iZSBJbGx1c3RyYXRvciAyNC4wLjAsIFNWRyBFeHBvcnQgUGx1Zy1JbiAuIFNWRyBWZXJzaW9uOiA2LjAwIEJ1aWxkIDApICAtLT4NCjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0i5Zu+5bGCXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNDAgNDAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDQwIDQwOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPg0KCS5zdDB7ZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7ZmlsbDojRkZGRkZGO30NCgkuc3Qxe2ZpbGw6Izc0MzlFQTt9DQoJLnN0MntlbmFibGUtYmFja2dyb3VuZDpuZXcgICAgO30NCgkuc3Qze2ZpbGw6IzFGOTFFMTt9DQoJLnN0NHtmaWxsOm5vbmU7c3Ryb2tlOiM0RDQzRkY7c3Ryb2tlLXdpZHRoOjAuNTt9DQoJLnN0NXtmaWxsOiM0RDQzRkY7fQ0KCS5zdDZ7ZmlsbDojRkZGRkZGO30NCjwvc3R5bGU+DQo8dGl0bGU+57yW57uEIDI0PC90aXRsZT4NCjxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPg0KPGcgaWQ9Iumhtemdoi0xIj4NCgk8ZyBpZD0i5ZCI5oiQIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTMuMDAwMDAwLCAtMTMuMDAwMDAwKSI+DQoJCTxnIGlkPSLnvJbnu4QtMjQiPg0KCQkJPGcgaWQ9Iue8lue7hC00IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMy4wMDAwMDAsIDEzLjAwMDAwMCkiPg0KCQkJCTxnIGlkPSLnvJbnu4QtMiI+DQoJCQkJCTxnIGlkPSLnn6nlvaJfMV8iPg0KCQkJCQkJPHBhdGggY2xhc3M9InN0MCIgZD0iTTUuODIsNGgxNy44MmMxLDAsMS44MiwwLjgxLDEuODIsMS44MnYxNy44MmMwLDEtMC44MSwxLjgyLTEuODIsMS44Mkg1LjgyYy0xLDAtMS44Mi0wLjgxLTEuODItMS44Mg0KCQkJCQkJCVY1LjgyQzQsNC44MSw0LjgxLDQsNS44Miw0eiIvPg0KCQkJCQkJPHBhdGggY2xhc3M9InN0MSIgZD0iTTIzLjY0LDI1Ljc2SDUuODJjLTEuMTcsMC0yLjEyLTAuOTUtMi4xMi0yLjEyVjUuODJjMC0xLjE3LDAuOTUtMi4xMiwyLjEyLTIuMTJoMTcuODINCgkJCQkJCQljMS4xNywwLDIuMTIsMC45NSwyLjEyLDIuMTJ2MTcuODJDMjUuNzYsMjQuODEsMjQuODEsMjUuNzYsMjMuNjQsMjUuNzZ6IE01LjgyLDQuM0M0Ljk4LDQuMyw0LjMsNC45OCw0LjMsNS44MnYxNy44Mg0KCQkJCQkJCWMwLDAuODQsMC42OCwxLjUyLDEuNTIsMS41MmgxNy44MmMwLjg0LDAsMS41Mi0wLjY4LDEuNTItMS41MlY1LjgyYzAtMC44NC0wLjY4LTEuNTItMS41Mi0xLjUySDUuODJ6Ii8+DQoJCQkJCTwvZz4NCgkJCQkJPGcgY2xhc3M9InN0MiI+DQoJCQkJCQk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNMTkuNjgsMTIuNjhoLTAuNTVjLTAuMTUtMC40My0wLjM4LTAuODktMC43MS0xLjM4Yy0wLjMyLTAuNDktMC42Mi0wLjc2LTAuOS0wLjgNCgkJCQkJCQljLTAuMTUtMC4wMi0wLjM0LTAuMDQtMC41Ni0wLjA1Yy0wLjIyLTAuMDEtMC40MS0wLjAyLTAuNTctMC4wMmgtMC4zM3Y3LjkxYzAsMC4xNywwLjAzLDAuMzIsMC4wOSwwLjQ1DQoJCQkJCQkJYzAuMDYsMC4xMywwLjE4LDAuMjMsMC4zNiwwLjMxYzAuMTEsMC4wNCwwLjI4LDAuMDksMC41MSwwLjEzYzAuMjMsMC4wNCwwLjQyLDAuMDgsMC41OSwwLjF2MC41NWgtNS42MnYtMC41NQ0KCQkJCQkJCWMwLjE0LTAuMDEsMC4zMy0wLjAzLDAuNTgtMC4wNnMwLjQyLTAuMDYsMC41MS0wLjFjMC4xOC0wLjA4LDAuMzEtMC4xOCwwLjM3LTAuMzFzMC4wOS0wLjI4LDAuMDktMC40NXYtNy45OEgxMy4yDQoJCQkJCQkJYy0wLjE2LDAtMC4zNSwwLjAxLTAuNTcsMC4wMmMtMC4yMiwwLjAxLTAuNDEsMC4wMy0wLjU2LDAuMDVjLTAuMjcsMC4wNC0wLjU3LDAuMy0wLjksMC44Yy0wLjMyLDAuNDktMC41NiwwLjk1LTAuNzEsMS4zOA0KCQkJCQkJCUg5LjkxVjkuOGg5Ljc3VjEyLjY4eiIvPg0KCQkJCQk8L2c+DQoJCQkJCTxnIGNsYXNzPSJzdDIiPg0KCQkJCQkJPHBhdGggY2xhc3M9InN0NCIgZD0iTTE5LjY4LDEyLjY4aC0wLjU1Yy0wLjE1LTAuNDMtMC4zOC0wLjg5LTAuNzEtMS4zOGMtMC4zMi0wLjQ5LTAuNjItMC43Ni0wLjktMC44DQoJCQkJCQkJYy0wLjE1LTAuMDItMC4zNC0wLjA0LTAuNTYtMC4wNWMtMC4yMi0wLjAxLTAuNDEtMC4wMi0wLjU3LTAuMDJoLTAuMzN2Ny45MWMwLDAuMTcsMC4wMywwLjMyLDAuMDksMC40NQ0KCQkJCQkJCWMwLjA2LDAuMTMsMC4xOCwwLjIzLDAuMzYsMC4zMWMwLjExLDAuMDQsMC4yOCwwLjA5LDAuNTEsMC4xM2MwLjIzLDAuMDQsMC40MiwwLjA4LDAuNTksMC4xdjAuNTVoLTUuNjJ2LTAuNTUNCgkJCQkJCQljMC4xNC0wLjAxLDAuMzMtMC4wMywwLjU4LTAuMDZzMC40Mi0wLjA2LDAuNTEtMC4xYzAuMTgtMC4wOCwwLjMxLTAuMTgsMC4zNy0wLjMxczAuMDktMC4yOCwwLjA5LTAuNDV2LTcuOThIMTMuMg0KCQkJCQkJCWMtMC4xNiwwLTAuMzUsMC4wMS0wLjU3LDAuMDJjLTAuMjIsMC4wMS0wLjQxLDAuMDMtMC41NiwwLjA1Yy0wLjI3LDAuMDQtMC41NywwLjMtMC45LDAuOGMtMC4zMiwwLjQ5LTAuNTYsMC45NS0wLjcxLDEuMzgNCgkJCQkJCQlIOS45MVY5LjhoOS43N1YxMi42OHoiLz4NCgkJCQkJPC9nPg0KCQkJCTwvZz4NCgkJCQk8ZyBpZD0i57yW57uELTMiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE3LjQwMDAwMCwgMTcuNDAwMDAwKSI+DQoJCQkJCTxnIGlkPSLnn6nlvaJfMl8iPg0KCQkJCQkJPHBhdGggY2xhc3M9InN0MCIgZD0iTS0xLjA0LTIuODVoMTcuODJjMSwwLDEuODIsMC44MSwxLjgyLDEuODJ2MTcuODJjMCwxLTAuODEsMS44Mi0xLjgyLDEuODJILTEuMDQNCgkJCQkJCQljLTEsMC0xLjgyLTAuODEtMS44Mi0xLjgyVi0xLjA0Qy0yLjg1LTIuMDQtMi4wNC0yLjg1LTEuMDQtMi44NXoiLz4NCgkJCQkJCTxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0xNi43OCwxOC45MUgtMS4wNGMtMS4xNywwLTIuMTItMC45NS0yLjEyLTIuMTJWLTEuMDRjMC4wMS0xLjE3LDAuOTYtMi4xMSwyLjEyLTIuMTFoMTcuODINCgkJCQkJCQljMS4xNywwLDIuMTIsMC45NSwyLjEyLDIuMTJ2MTcuODJDMTguOSwxNy45NiwxNy45NSwxOC45MSwxNi43OCwxOC45MXogTS0xLjA0LTIuNTVjLTAuODMsMC0xLjUxLDAuNjgtMS41MiwxLjUxdjE3LjgzDQoJCQkJCQkJYzAsMC44NCwwLjY4LDEuNTIsMS41MiwxLjUyaDE3LjgyYzAuODQsMCwxLjUyLTAuNjgsMS41Mi0xLjUyVi0xLjAzYzAtMC44NC0wLjY4LTEuNTItMS41Mi0xLjUySC0xLjA0eiIvPg0KCQkJCQk8L2c+DQoJCQkJCTxnIGlkPSLnvJbnu4QiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExLjQwMDAwMCwgOC40MDAwMDApIj4NCgkJCQkJCTxnIGlkPSLot6/lvoQiPg0KCQkJCQkJCTxwYXRoIGNsYXNzPSJzdDMiIGQ9Ik0tMy40NCwxLjg0YzEuMjYsMCwyLjI3LTEsMi4yNy0yLjI0di0zLjcxYzAtMS4yNC0xLjAyLTIuMjQtMi4yNy0yLjI0cy0yLjI3LDEtMi4yNywyLjI0djMuNzENCgkJCQkJCQkJQy01LjY4LDAuODQtNC42OSwxLjg0LTMuNDQsMS44NHoiLz4NCgkJCQkJCQk8cGF0aCBjbGFzcz0ic3Q1IiBkPSJNLTMuNDQsMi4wOWMtMS4zOCwwLTIuNDktMS4wOS0yLjUyLTIuNDh2LTMuNzJjMC0xLjM3LDEuMTMtMi40OSwyLjUyLTIuNDlzMi41MiwxLjEyLDIuNTIsMi40OXYzLjcxDQoJCQkJCQkJCUMtMC45MiwwLjk3LTIuMDUsMi4wOS0zLjQ0LDIuMDl6IE0tMy40NC02LjFjLTEuMTEsMC0yLjAyLDAuODktMi4wMiwxLjk5djMuNzFjMC4wMywxLjExLDAuOTIsMS45OSwyLjAyLDEuOTkNCgkJCQkJCQkJYzEuMTEsMCwyLjAyLTAuODksMi4wMi0xLjk5di0zLjcxQy0xLjQyLTUuMjEtMi4zMy02LjEtMy40NC02LjF6Ii8+DQoJCQkJCQk8L2c+DQoJCQkJCQk8ZyBpZD0i6Lev5b6EXzFfIj4NCgkJCQkJCQk8cGF0aCBjbGFzcz0ic3QzIiBkPSJNMC4wMi0xLjg3Yy0wLjI0LDAtMC40NSwwLjItMC40NSwwLjQzdjEuMTdjMCwxLjYzLTEuMzgsMi45NS0zLjEsMi45NXMtMy4xLTEuMzItMy4xLTIuOTV2LTEuMjkNCgkJCQkJCQkJYzAtMC4yMy0wLjIxLTAuNDMtMC40NS0wLjQzcy0wLjQ1LDAuMi0wLjQ1LDAuNDN2MS4yOWMwLDEuOTUsMS41NiwzLjU4LDMuNTUsMy43OHYwLjkyaC0xLjVjLTAuMjQsMC0wLjQ1LDAuMi0wLjQ1LDAuNDMNCgkJCQkJCQkJczAuMjEsMC40MywwLjQ1LDAuNDNoMy45MWMwLjI0LDAsMC40NS0wLjIsMC40NS0wLjQzcy0wLjIxLTAuNDMtMC40NS0wLjQzaC0xLjVWMy41MmMxLjk5LTAuMiwzLjU1LTEuODMsMy41NS0zLjc4di0xLjE3DQoJCQkJCQkJCUMwLjQ3LTEuNywwLjI2LTEuODcsMC4wMi0xLjg3eiIvPg0KCQkJCQkJCTxwYXRoIGNsYXNzPSJzdDUiIGQ9Ik0tMS41Nyw1LjU0aC0zLjkxYy0wLjM4LDAtMC43LTAuMzEtMC43LTAuNjhzMC4zMi0wLjY4LDAuNy0wLjY4aDEuMjVWMy43M2MtMi4wMS0wLjMxLTMuNTUtMi4wMy0zLjU1LTQNCgkJCQkJCQkJdi0xLjI5YzAtMC4zNywwLjMyLTAuNjgsMC43LTAuNjhzMC43LDAuMzEsMC43LDAuNjh2MS4yOWMwLDEuNDksMS4yOCwyLjcsMi44NSwyLjdjMS41NywwLDIuODUtMS4yMSwyLjg1LTIuN3YtMS4xNw0KCQkJCQkJCQljMC0wLjM3LDAuMzItMC42OCwwLjctMC42OGMwLjM5LDAsMC42OSwwLjI5LDAuNzEsMC42OHYxLjE4YzAsMS45Ny0xLjU0LDMuNjktMy41NSw0djAuNDRoMS4yNWMwLjM4LDAsMC43LDAuMzEsMC43LDAuNjgNCgkJCQkJCQkJUy0xLjE5LDUuNTQtMS41Nyw1LjU0eiBNLTUuNDgsNC42OGMtMC4xLDAtMC4yLDAuMDktMC4yLDAuMThjMCwwLjA5LDAuMSwwLjE4LDAuMiwwLjE4aDMuOTFjMC4xLDAsMC4yLTAuMDksMC4yLTAuMTgNCgkJCQkJCQkJYzAtMC4wOS0wLjEtMC4xOC0wLjItMC4xOGgtMS43NVYzLjI5bDAuMjItMC4wMmMxLjg3LTAuMTksMy4zMy0xLjc0LDMuMzMtMy41M3YtMS4xN0MwLjIyLTEuNjktMC4xOC0xLjYyLTAuMTgtMS40NHYxLjE3DQoJCQkJCQkJCWMwLDEuNzYtMS41LDMuMi0zLjM1LDMuMmMtMS44NSwwLTMuMzUtMS40NC0zLjM1LTMuMnYtMS4yOWMwLTAuMDktMC4xLTAuMTgtMC4yLTAuMThjLTAuMSwwLTAuMiwwLjA5LTAuMiwwLjE4djEuMjkNCgkJCQkJCQkJYzAsMS43OSwxLjQ2LDMuMzQsMy4zMywzLjUzbDAuMjMsMC4wMnYxLjRILTUuNDh6Ii8+DQoJCQkJCQk8L2c+DQoJCQkJCTwvZz4NCgkJCQk8L2c+DQoJCQkJDQoJCQkJCTxnIGlkPSLnvJbnu4RfMV8iIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ0Ljk4MzQ5NCwgOC4yMDE3OTUpIHNjYWxlKC0xLCAxKSByb3RhdGUoLTYwLjAwMDAwMCkgdHJhbnNsYXRlKC00NC45ODM0OTQsIC04LjIwMTc5NSkgdHJhbnNsYXRlKDM4LjQ4MzQ5NCwgNC4yMDE3OTUpIj4NCgkJCQkJPGcgaWQ9Iui3r+W+hF8yXyI+DQoJCQkJCQk8cGF0aCBjbGFzcz0ic3Q2IiBkPSJNMTIuMDQsMTUuMTh2LTEuMTdMOS4xNSwxNS44Yy0wLjE5LDAuMTItMC4xOSwwLjMyLDAsMC40NGwyLjg4LDEuNzlsMC0xLjE3YzEuNjMsMCwzLjE0LDAuMjUsNC40MywxLjUxDQoJCQkJCQkJQzE1Ljg4LDE2LjAyLDEzLjQ0LDE1LjE4LDEyLjA0LDE1LjE4Ii8+DQoJCQkJCQk8cGF0aCBjbGFzcz0ic3QxIiBkPSJNOC43OCwxNi4yOGMwLjA1LDAuMDgsMC4xMiwwLjE2LDAuMjEsMC4yMWwzLjM0LDIuMDhsMC0xLjQxYzEuMzQsMC4wMywyLjczLDAuMjYsMy45MiwxLjQyTDE3LDE5LjMyDQoJCQkJCQkJbC0wLjI1LTEuMDJjLTAuNTctMi4zNS0yLjg1LTMuMy00LjQxLTMuNDFsMC0xLjQybC0zLjM1LDIuMDdjLTAuMTgsMC4xMi0wLjI4LDAuMjktMC4yOCwwLjQ4DQoJCQkJCQkJQzguNzEsMTYuMTEsOC43MywxNi4yLDguNzgsMTYuMjh6IE0xMS43MywxNy40OWwtMi4zNi0xLjQ3bDIuMzctMS40N2wwLDAuOTNsMC4zLDBjMS4wOCwwLDIuODIsMC41NSwzLjcsMS45NQ0KCQkJCQkJCWMtMS4yMS0wLjc1LTIuNTMtMC44Ny0zLjcxLTAuODdsLTAuMywwTDExLjczLDE3LjQ5eiIvPg0KCQkJCQk8L2c+DQoJCQkJPC9nPg0KCQkJPC9nPg0KCQk8L2c+DQoJPC9nPg0KPC9nPg0KPC9zdmc+DQo=";

	class CxText2Speech {
		constructor(runtime) {
			this.runtime = runtime;
			this.per = null;
			this.voiceArr = [
				{ value: 'baidu', text: '百度' },
				{ value: '自动', text: '自动' }
			];
		}

		getInfo() {

			return {
				id: 'cxtext2speech',
				name: '语音合成',
				// palette icon
				color1: '#508050', // 主色（浅绿色）
				color2: '#008000', // 次色（稍深的浅绿）
				menuIconURI: svgIcon,
				blockIconURI: svgIcon,
				blocks: [
					{
						opcode: 'say',
						blockType: Scratch.BlockType.COMMAND,
						text: '语言 [VOICE] 说： [STRING]',
						arguments: {
							VOICE: {
								type: Scratch.ArgumentType.STRING,
								menu: 'voices',
								defaultValue: '自动'
							},
							STRING: {
								type: Scratch.ArgumentType.STRING,
								defaultValue: '你好'
							}
						},
						// block icon
						iconURI: svgIcon
					},
					{
						opcode: 'setVoice',
						blockType: Scratch.BlockType.COMMAND,
						text: '设置语音为 [VOICE_ID]',
						arguments: {
							VOICE_ID: {
								type: Scratch.ArgumentType.STRING,
								menu: 'PER',
								defaultValue: '0'
							}
						}
					}
				],
				menus: {
					voices: {
						items: this.voiceArr,
						acceptReporters: true
					},
					PER: {
						items: [
							{ text: '度小美', value: '0' },
							{ text: '度小宇', value: '1' },
							{ text: '度逍遥', value: '3' },
							{ text: '度丫丫', value: '4' }
						],
						acceptReporters: false
					}
				}
			};
		}

		say(args) {
			const text = args.STRING;
			const voice = args.VOICE;
			const url = `https://ai.eliteu.cn/wxapi/tts?text=${encodeURIComponent(text)}${this.per ? `&per=${this.per}` : ''}`;
			if (voice === '自动') {
				return new Promise(resolve => {
					const audio = new Audio(url);
					audio.onended = resolve;
					audio.onerror = () => {
						const utter = new SpeechSynthesisUtterance(text);
						utter.onend = resolve;
						window.speechSynthesis.speak(utter);
					};
					audio.play();
				});
			} else {
				return new Promise(resolve => {
					const audio = new Audio(url);
					audio.onended = resolve;
					audio.onerror = resolve;
					audio.play();
				});
			}
		}

		setVoice(args) {
			// store the selected PER voice ID
			this.per = args.VOICE_ID;
		}
	}

	Scratch.extensions.register(new CxText2Speech());
})(Scratch);